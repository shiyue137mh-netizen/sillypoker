# 卡牌桌面 - 指令规格

## 1. 核心结构

所有指令都由一个方括号 `[]` 包裹，并分为指令头和数据块两部分。

### 指令块 `<command>`
- **用途**: 当一次AI响应中需要包含叙事文本和指令时，**所有**指令都必须被集中包裹在一个位于消息**末尾**的 `<command>` 块中。这用于将人类可读的剧情与机器可读的指令清晰地分离开。
- **规则**: 如果一次响应中包含多个指令，它们必须全部放在同一个 `<command>` 块内。
- **注意**: 在本技术文档的指令定义部分，为了清晰地展示单个指令的结构，通常会省略 `<command>` 包裹。只有在展示完整的、包含叙事的AI响应示例时，才会使用它。

**输出顺序**: `叙事文本... <command>指令块</command>`

#### 指令头
-   格式: `类别:类型`
-   `类别` 必须是 `Game`, `Action`, `Event`, `Item` 或 `Map` 之一。

#### 数据块
-   格式: `data:<JSON对象>`
-   `<JSON对象>` 是一个严格格式的JSON对象，它包含了执行该指令所需的所有参数。
-   **JSON语法**: 所有键 (keys) 和字符串值 (string values) 都必须用双引号 `"` 包裹。

### 2. 完整指令示例

这是一个典型的游戏开始流程，角色在说完话后，于消息末尾附加一个包含所有初始化指令的指令块。
<command>
    [Game:Start, data:{"game_type": "TexasHoldem", "players": ["{{user}}", "拦路劫匪"], "initial_state": { "name": "拦路劫匪", "play_style": "Aggressive", "chips": 800, "hand": [] }}]
    [Game:Function, type:发牌, data:{"actions":[
      {"target":"player", "count":2, "visibility":"owner"},
      {"target":"enemy", "name":"拦路劫匪", "count":2, "visibility":"owner"}
    ]}]
</command>

---

## 3. 指令执行顺序 (Instruction Execution Order)

为了确保游戏的正确设置，指令的发出顺序至关重要，尤其是在需要非标准牌堆（例如多副牌）的游戏中。

- **`[Game:Start]` 优先**: 此指令负责初始化游戏的基本框架和**一副标准的52张扑克牌**。它必须是开始一局新游戏时的第一个指令。
- **`[Game:SetupDeck]` 作为覆盖**: 如果游戏需要特殊的牌堆（如两副牌、带王牌等），此指令**必须**在 `[Game:Start]` 之后立即发出。它会用你定义的牌堆**覆盖**掉由 `[Game:Start]` 创建的默认牌堆。

#### 正确的顺序范例 (四人斗地主):
```
<command>
[Game:Start, data:{"game_type": "DouDiZhu_4Player", "players": ["{{user}}", "赌圣", ...], ...}]
[Game:SetupDeck, data:{"num_decks": 2, "jokers": 4}]
</command>
```
**总结**: 始终先用 `[Game:Start]` 宣布游戏开始，然后再用 `[Game:SetupDeck]` (如果需要) 来“定制”牌局的工具。

---

## 4. 指令类别

-   **游戏指令**: 管理牌局内部的流程，指令以 `[Game:...]` 或 `[Action:...]` 开头。
-   **提示指令**: 在牌局中提供可选的教程和建议，指令以 `[Game:Hint]` 开头。
-   **事件指令**: 直接修改游戏世界的状态数据，指令以 `[Event:...]` 开头。
-   **地图指令**: 修改当前楼层的地图结构，指令以 `[Map:...]` 开头。
-   **道具指令**: 管理道具的创造和使用，指令以 `[Item:...]` 开头。
-   **命运之骰**: 引入真正的随机性，用于处理需要判定的事件。
-   **叙事准则**: 规定了在生成剧情时哪些信息是可见的，哪些是保密的。
-   **地图与奖励范例**: 查看在不同地图节点下如何使用指令。