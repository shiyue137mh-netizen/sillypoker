# AI Card Table - 已实现功能文档 (v8.5.0)

## 1. 核心架构与稳定性 (Core Architecture & Stability)

这是插件的基石，确保了所有上层功能的稳定运行。

*   **模块化架构 (ES6 Modules)**: 项目已完全迁移至现代化的模块化结构 (`dataHandler`, `ui`, `events`, `audioManager`等)，代码清晰，易于维护和扩展。
*   **单一数据源 (Single Source of Truth)**: 严格遵循所有游戏状态均由 SillyTavern 的**世界书 (World Book)** 统一管理。前端UI和AI角色都从此唯一来源读取数据，从根本上杜绝了状态不同步的问题。
*   **原子化世界书操作**: 所有对世界书的写入操作都通过 `TavernHelper_API.updateWorldbookWith` 进行。这种“读取-修改-写入”的原子操作模式，彻底解决了旧版本中因异步竞争导致的数据丢失或损坏问题。
*   **自动化世界书管理**:
    *   **自动创建与绑定**: 当为新角色首次打开插件时，会自动创建其专用的 `SillyPoker_Data_{{char}}` 世界书，并将其绑定到角色卡，实现了**零手动配置**的开箱即用体验。
    *   **多角色支持**: 插件能够完美地在不同角色之间切换，自动加载和管理对应角色的独立游戏世界，互不干扰。
*   **健壮的指令解析器 (V2 Parser)**: 指令解析器经过重构，能够稳定、准确地解析AI发出的复杂指令，即使指令的`data`块中包含**深度嵌套的JSON对象**也能正确处理。

## 2. 完整的Roguelike游戏循环 (Complete Roguelike Gameplay Loop)

插件已经具备一个可以从头玩到尾的完整Roguelike核心循环。

*   **挑战生命周期**:
    *   **难度选择**: 游戏从一个清晰的难度选择界面开始，玩家可以根据偏好选择不同的初始资源（生命值和筹码）。
    *   **程序化地图生成**: 选择难度后，会自动生成一个《杀戮尖塔》风格的、程序化的、多路径的楼层地图。
    *   **挑战重置/放弃**: 玩家可以在“设置”中随时**重置当前挑战**，返回难度选择界面。
*   **多楼层进展 (Multi-Floor Progression)**:
    *   **首领挑战**: 每层地图的终点都有一个“首领”节点。
    *   **进入下一层**: 成功击败首领后（AI需发出 `result: "boss_win"` 指令），地图上会出现“前往下一层”的按钮，点击后将生成一个全新的、更高层数的地图，实现无限爬塔的可能。
    *   **特殊房间**: 击败首领后，现在会解锁通往特殊的“天使房”或“恶魔房”的路径。
*   **探索与导航**:
    *   **地图交互**: 玩家可以在地图上点击可达节点查看详情，并通过按钮或双击确认**前往该节点**。
    *   **秘密房间**: 玩家可以在当前节点消耗筹码进行**搜索**，有几率发现隐藏的房间，为探索增加了额外的维度和奖励。

## 3. 智能AI交互系统 (Intelligent AI Interaction)

我们为AI提供了强大的工具，使其能够成为一个有感知、有决策能力的“游戏主持人”。

*   **情境感知上下文 (`<context>` Block)**: 当玩家结束回合时，系统会自动生成一个包含当前完整游戏状态的`<context>`块，并附加在系统提示后发送给AI。这使得AI能够：
    *   **获取完整战局**: 了解当前的游戏类型、轮到谁行动、下一个行动者是谁 (`next_turn`)、彩池金额、公共牌、双方筹码等。
    *   **感知地图环境**: 了解当前的楼层、节点类型（如`elite`, `boss`）、房间属性（如`big`大房间）以及地图探索进度。
*   **强大的指令集**: AI可以通过标准化的指令来精确控制游戏流程的方方面面。
    *   **游戏管理**: `[Game:Start]`, `[Game:End]`, `[Game:SetupDeck]` (自定义牌堆)。
    *   **卡牌操作**: `[Game:Function, type:发牌]`, `[Game:Function, type:Modify]` (修改任意卡牌的属性)。
    *   **游戏行动**: `[Action:Bet]`, `[Action:Call]`, `[Action:Check]`, `[Action:Fold]` 等所有标准扑克操作。
    *   **状态修改**: `[Event:Modify]` 作为修改玩家/敌人所有非卡牌数据的**唯一**入口（如生命、筹码、道具、状态效果）。
    *   **动态地图修改**: `[Map:Modify]` 允许AI根据复杂的条件（如“寻找未来路径上一个最偏僻的敌人节点”）智能地改变地图结构，创造动态事件。
    *   **UI提示**: `[Game:Hint]` 允许AI向玩家显示临时的教程提示气泡。

## 4. 玩家交互与UI/UX (Player Interaction & UI/UX)

前端UI已经实现了流畅、反馈及时的玩家操作体验。

*   **“暂存-提交”操作模型 (Stage-Commit Model)**:
    *   **即时反馈**: 玩家点击“下注”、“跟注”等操作后，该操作会进入一个“暂存区”。UI会**立即更新**以反映此操作（如筹码在视觉上减少），提供极佳的即时反馈。
    *   **灵活撤销**: 玩家可以在提交前，单独撤销暂存区中的任意一个操作，或一键**全部撤销**。
    *   **统一提交**: 玩家点击“结束回合”按钮后，所有暂存的操作才会被固化到世界书，并打包成一个系统提示发送给AI。
*   **完整的游戏桌面 (Game Table)**:
    *   **多对手支持**: UI能够根据AI在 `[Game:Start]` 中定义的玩家数量，动态渲染出1至3个对手的坐席（分别位于上、左、右侧），并正确处理多人牌局的布局。
    *   **卡牌渲染**: 能够正确渲染公开牌、玩家手牌、以及敌人的隐藏牌背。
    *   **信息显示**: 清晰地显示彩池金额、公共牌、对手信息（名称、风格、筹码）以及当前行动高亮。
*   **HUD与侧边栏**:
    *   **顶部HUD**: 实时显示玩家的生命值、筹码、状态效果，以及当前牌局类型。
    *   **可伸缩道具栏**: 一个可以从侧边滑入/滑出的道具栏，用于显示和使用玩家获得的道具。
*   **丰富的操作选项**:
    *   **标准操作**: 提供“下注”、“跟注”、“过牌”、“弃牌”等按钮。
    *   **快捷/特殊操作**: 提供“All In”按钮和“自定义动作”输入选项。
    *   **叙事操作**: 游戏外提供“尝试逃跑”、“投降”、“求饶”等按钮，将叙事选择权交给玩家。
    *   **表情/台词轮盘**: 提供一个快捷轮盘，让玩家可以方便地发送预设的经典台词。

## 5. 游戏机制与系统 (Game Mechanics & Systems)

*   **道具系统 (Item System)**:
    *   **主动/被动区分**: 道具分为获得即生效的“被动”道具和需要点击使用的“主动”道具。
    *   **AI效果结算**: 玩家使用主动道具时，前端会向AI发送标准化的系统提示 `({{user}}使用了道具...)`，由AI负责发出对应的 `[Event:Modify]` 指令来结算效果，确保了逻辑的统一。
*   **状态效果系统 (Status Effects)**: 支持为玩家或敌人添加/移除带有持续时间的状态效果，并显示在UI上。
*   **玩家历史记录 (Game History)**: 提供一个独立的、对玩家友好的游戏历史面板，记录了下注、发牌、事件等关键节点，与开发者日志分离。

## 6. 打磨与生活质量 (Polish & Quality of Life)

*   **动画效果 (Animations)**:
    *   **筹码动画**: 玩家或AI下注/跟注时，有筹码从其位置飞向彩池的动画；彩池结算时，筹码会飞向赢家。
    *   **发牌动画**: 卡牌从牌堆飞向玩家、对手或公共区域的动画。
    *   **UI动画**: 重要的UI元素（如`All In`按钮、状态提示）都有相应的动画反馈。
    *   **地图动画**: 发现秘密房间时，会有节点抖动和路径绘制的动画。
*   **音效与音乐 (Audio System)**:
    *   **音效 (SFX)**: 为所有关键UI交互（按钮点击、发牌、下注等）都配备了音效。
    *   **背景音乐 (BGM)**: 内置了一个完整的BGM播放器，支持**播放列表**、上一曲/下一曲、播放/暂停和音量控制。
*   **可定制的UI**:
    *   **可拖拽面板**: 整个插件面板可以通过其头部自由拖拽。
    *   **动态缩放**: 面板会根据浏览器窗口大小自动缩放，以适应不同分辨率。
    *   **可调字体大小**: 设置中提供了滑块，允许玩家自由调整整个插件界面的字体大小，所有UI元素都会**按比例**平滑缩放。
    *   **位置重置**: 提供“重置UI位置”按钮，防止玩家将面板拖出屏幕无法找回。