# AI 卡牌桌面 - 全功能测试指南 v1.0

## 0. 引言

**目的**: 本文档提供了一套标准化的测试流程，旨在系统性地验证“AI卡牌桌面”插件的各项功能，确保其稳定性、健壮性和用户体验。

**准备工作**:
1.  确保插件已成功加载到 SillyTavern 中。
2.  打开浏览器的开发者工具 (F12)，切换到“控制台(Console)”标签页，以便观察`[SillyPoker]`开头的日志输出。
3.  在测试前，建议为测试角色清除所有旧的`SillyPoker_Data_`世界书条目，以模拟全新环境。

---

## 1. 初始化与设置测试 (Initialization & Setup)

#### **测试用例 1.1: 首次加载与世界书创建**
-   **步骤**:
    1.  选择一个从未玩过本插件的角色。
    2.  打开插件面板。
-   **预期结果**:
    1.  面板应显示 "当前角色尚未绑定游戏世界书"。
    2.  应出现一个 "创建/修复游戏世界书" 的按钮。
    3.  点击该按钮后，按钮消失，UI切换到“难度选择”界面。
    4.  检查世界书，应已创建名为 `SillyPoker_Data_{{char}}` 的新世界书并已绑定到当前角色。

#### **测试用例 1.2: 已有世界书加载**
-   **步骤**:
    1.  针对已完成上一步测试的角色，关闭并重新打开插件面板。
-   **预期结果**:
    1.  面板应直接显示“难度选择”界面（如果挑战未开始）或游戏界面（如果挑战已在进行中）。
    2.  不应再显示“创建/修复游戏世界书”按钮。

---

## 2. 核心 Roguelike 循环测试 (Core Roguelike Loop)

#### **测试用例 2.1: 开始新挑战**
-   **步骤**:
    1.  在“难度选择”界面，点击“普通”难度。
-   **预期结果**:
    1.  玩家数据被正确初始化（3点生命，1000筹码）。
    2.  UI自动切换到“地图界面”标签页，并显示一张新生成的地图。
    3.  `runInProgress` 状态应为 `true`，顶部HUD正确显示玩家状态。
    4.  背景音乐（BGM）开始播放。

#### **测试用例 2.2: 地图导航与遭遇**
-   **步骤**:
    1.  在地图上，点击一个第一行的、可到达的节点。
    2.  在右侧的详情面板中，点击“前往此节点”按钮。
-   **预期结果**:
    1.  地图上玩家的当前位置图标移动到新节点。
    2.  聊天框中自动发送一条系统提示 `({{user}}移动到了一个...节点。)`。
    3.  UI自动切换到“游戏界面”标签页。
    4.  AI 响应系统提示，并发出 `[Game:Start]` 和 `[Game:Function, type:发牌]` 指令，开始一场牌局。

#### **测试用例 2.3: 完整牌局流程**
-   **步骤**:
    1.  等待AI完成发牌和它的第一个行动（如下注）。
    2.  在玩家回合，点击“跟注”按钮。
    3.  在弹出的输入框中确认金额或直接确认。
    4.  观察暂存区出现“跟注”的行动条。
    5.  点击右下角的“结束回合”按钮（播放图标）。
    6.  重复此流程，直到AI发出 `[Game:End]` 指令结束牌局。
-   **预期结果**:
    1.  所有行动（下注、跟注、发公共牌等）都能在UI上正确、实时地反映出来。
    2.  筹码、彩池、手牌等数据在每次行动后都与世界书保持一致。
    3.  游戏严格按照回合制进行。
    4.  牌局结束后，若胜利，奖励通过 `[Event:Modify]` 指令正确发放。

#### **测试用例 2.4: 战斗失败与生命值扣除**
-   **步骤**:
    1.  在牌局中，立即点击“弃牌”并“结束回合”，故意输掉牌局。
    2.  等待AI发出 `[Game:End, data:{"result":"lose", ...}]` 指令。
-   **预期结果**:
    1.  顶部HUD中的玩家生命值减少1点。
    2.  弹出“失败”的提示消息 (Toast)。
    3.  UI自动返回到“地图界面”。

#### **测试用例 2.5: 挑战结束 (Game Over)**
-   **步骤**:
    1.  重复“战斗失败”的流程，直到玩家生命值归零。
-   **预期结果**:
    1.  弹出“游戏结束”的提示。
    2.  UI自动返回到“难度选择”界面。
    3.  `runInProgress` 状态变为 `false`。

#### **测试用例 2.6: 击败首领与进入下一层**
-   **步骤**:
    1.  导航至地图顶端的“首领”节点并战胜它。
    2.  等待AI发出 `[Game:End, data:{"result":"boss_win", ...}]` 指令。
-   **预期结果**:
    1.  地图界面顶部应出现一个“前往下一层”的按钮。
    2.  点击该按钮后，会生成一张全新的、层数+1的地图。

---

## 3. UI/UX 与功能性测试 (UI/UX & Functionality)

#### **测试用例 3.1: 玩家操作暂存与撤销**
-   **步骤**:
    1.  在牌局中，点击“下注”，输入金额并确认。
    2.  观察暂存区出现“下注: 金额”的行动条。
    3.  点击该行动条旁边的 `×` 按钮。
    4.  再次点击“下注”，然后点击“过牌”。
    5.  点击“结束回合”按钮左侧的“全部撤销”按钮。
-   **预期结果**:
    1.  暂存的行动能够被正确添加和单独移除。
    2.  下注时，玩家筹码会立即减少；撤销下注后，筹码会立即返还。
    3.  “全部撤销”按钮能一次性清空所有暂存操作并返还筹码。
    4.  “结束回合”按钮上的计数器能准确反映暂存操作的数量。

#### **测试用例 3.2: 道具系统**
-   **步骤**:
    1.  通过战胜“精英敌人”获得一个主动道具。
    2.  点击右侧的道具栏展开按钮。
    3.  点击刚刚获得的主动道具图标。
    4.  在弹出的确认框中点击“确认”。
-   **预期结果**:
    1.  道具正确显示在道具栏中。
    2.  点击后，聊天框发送 `({{user}}使用了道具...)` 的系统提示。
    3.  AI 正确响应此提示，并发出 `[Event:Modify]` 指令来结算道具效果。
    4.  道具从道具栏中消失（因为是主动消耗品）。

#### **测试用例 3.3: 音效与音乐 (SFX & BGM)**
-   **步骤**:
    1.  切换到“设置”标签页。
    2.  点击“游戏音效”的开关按钮。
    3.  控制BGM的播放/暂停、上一曲/下一曲。
    4.  拖动BGM的音量条。
    5.  在音效开启时，点击UI中的各个按钮（如下注、切换标签页等）。
-   **预期结果**:
    1.  音效和音乐的开关功能正常。
    2.  BGM播放器控件（播放/暂停/切歌/音量）工作正常。
    3.  UI交互能触发对应的音效。

#### **测试用例 3.4: 设置与特殊操作**
-   **步骤**:
    1.  在“设置”标签页，点击“重新开始挑战”按钮并确认。
    2.  在牌局中，点击顶部操作栏的“尝试逃跑”按钮并确认。
-   **预期结果**:
    1.  “重新开始挑战”能正确清空所有游戏数据并返回难度选择界面。
    2.  “尝试逃跑”能正确向AI发送提示，并由AI决定逃跑结果。

---

## 4. 指令与数据压力测试 (Command & Data Stress Test)

#### **测试用例 4.1: 复杂指令解析**
-   **步骤**:
    1.  在聊天框中，手动输入一个包含多个修改项、且JSON格式复杂的指令。
        - 示例: `<command>[Event:Modify, data:{"target":"{{user}}", "modifications":[ {"field":"chips", "operation":"add", "value":-150}, {"field":"status_effects", "operation":"add", "value":{"name":"眩晕", "description":"无法行动一回合", "duration":1}} ]}]</command>`
-   **预期结果**:
    1.  插件能正确解析并执行指令。
    2.  控制台中应显示 `[Parser V2] SUCCESS` 的日志，并且没有JSON解析错误。
    3.  玩家状态（筹码、状态效果）被正确更新。

#### **测试用例 4.2: 多人牌局渲染**
-   **步骤**:
    1.  切换到“游戏规则”标签页。
    2.  找到“极限测试：四人斗地主”部分。
    3.  将其提供的完整指令复制并粘贴到聊天框中发送。
-   **预期结果**:
    1.  游戏桌UI能正确渲染出3个对手（分别位于左、上、右侧）和玩家。
    2.  每人25张手牌被正确发出和渲染。
    3.  UI布局保持稳定，没有元素重叠或溢出。

#### **测试用例 4.3: 快速切换角色**
-   **步骤**:
    1.  准备两个角色，一个有正在进行中的游戏，另一个没有。
    2.  在SillyTavern的角色列表中，快速来回切换这两个角色，并每次都打开插件面板。
-   **预期结果**:
    1.  插件面板能为每个角色正确、快速地加载其对应的游戏状态。
    2.  控制台中没有出现错误。
    3.  两个角色的游戏数据没有发生混淆或损坏。
